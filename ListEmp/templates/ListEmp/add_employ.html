{% extends "ListEmp/basic.html" %}                 <!-- Наследование от базового шаблона -->
{% load static %}                                  <!-- Загрузка статических файлов -->
{% block title %}Добавление сотрудника{% endblock %}  <!-- Заголовок страницы -->

{% block content %}  <!-- Начало блока с контентом   m-5    -->

<div class="mx-auto p-3 " > 
  <div><center><p class="h3 mb-3 m-3">Добавление сотрудника: </p></center></div>
    <form id="AddEmployForm" name="AddEmployForm" method ="POST">
     {% csrf_token %}  <!-- Защита от CSRF атак --> 

      <div class="mx-auto p-5" style="width: 570px;">  <!--  Блок содержащий поля формы   -->

        <!-- Поле "Ф.И.О" -->
        <div class="input-group mb-3">
          <span class="input-group-text bg-primary text-light px-4" id="basic-fio" style="width: 100px;" >Ф. И. О</span>
          <input type="text" id="fio" name="fio" class="form-control" placeholder="Фамилия и инициалы сотрудника" aria-label="Имя пользователя" aria-describedby="basic-fio">
        </div>

        <!-- Поле "Пол" -->
        <div class="input-group mb-3">
          <label class="input-group-text bg-primary text-light px-5" for="gender" style="width: 100px;">Пол</label>
          <select id="gender" name="gender" class="form-select" id="Select-gender">
            <option selected>Выберите пол сотрудника</option>
            <option value="1">Мужской</option>
            <option value="2">Женский</option>
          </select>
        </div>
   
        <!-- Поле "Возраст" -->
        <div class="input-group mb-3">
          <span class="input-group-text bg-primary text-light px-4" id="basic-addon1" style="width: 100px;">Возраст</span>
          <input type="text" id="age" name="age" class="form-control" placeholder="Возраст сотрудника" aria-label="Возраст" aria-describedby="basic-addon1">
        </div>

        <!-- Поле "Категория"         -->
        <div class="input-group mb-3">
          <label class="input-group-text bg-primary text-light px-2" for="category" style="width: 100px;">Категория</label>
            <select class="form-select" id="category"  name="category">  
              <option selected>Выберите категорию к которой относится сотрудник</option>
            </select>
   <script>  //  Подгружаем в поле "Категория" значения из БД 
    document.addEventListener('DOMContentLoaded', function() { // После полной загрузки страницы
        fetch('api/category/')                  // Запрашиваем на сервере все существующие категории
            .then(response => response.json())  // Получаем ответ
            .then(data => {
                const select = document.getElementById('category');  // Ищем на странице элемент category
                data.forEach(item => {                                // Начинаем перебор полученных с сервера данных. И на каждой итерации
                    const option = document.createElement('option');  // Создаём  элемент option
                    option.value = item.id;                           // Присваиваем текущий идентификатор
                    option.textContent = item.name_category;          // Присваиваем текущее наименование категории
                    select.appendChild(option);                       // Добавляем получившийся объект option в элемент category
                });
            })
            .catch(error => console.error('Ошибка:', error));     // В случае ошибки выводим её в консоль
    });
    </script>
        </div>

        <!-- Поле "Должность"    input-group-text       -->
        <div class="input-group mb-3">
          <label class="input-group-text bg-primary text-light px-2" for="positions" style="width: 100px;">Должность</label>
          <select id="positions" name="positions" class="form-select" >
            <option selected>Выберите должность сотрудника</option>
          </select>
        </div>

<script>  
// Обработчик который срабатывает когда страница полностью загружена (DOMContentLoaded)
document.addEventListener('DOMContentLoaded', function() {  
            const categorySelect = document.querySelector('#category');  // Ищем на странице элемент category
            const positionSelect = document.querySelector('#positions'); // Ищем на странице элемент positions
            // Обработчик который срабатывает тогда когда происходят изменения (change) в элементе categorySelect
            categorySelect.addEventListener('change', async function(event) { // function(event) — анонимная функция‑обработчик, 
                                                                              // которая получит объект события event при срабатывании.
                                                                              // event — объект события, содержащий:
                                                                              //   - event.target — сам элемент (categorySelect);
                                                                              //   - event.target.value — новое значение элемента;
             
                let selectedCategoryId = event.target.value; // Запоминаем новое значение элемента categorySelect
                // ПРОВЕРКА НА СУЩЕСТВОВАНИЕ ЗНАЧЕНИЯ В ПОЛЕ "КАТЕГОРИЯ"
                if (!selectedCategoryId) {                  // Если значение categorySelect отсутствует
                    positionSelect.disabled = true;  // Делаем элемент PositionSelect недоступным для взаимодействия
                    positionSelect.innerHTML = '<option value="">Выберите категорию сначала...</option>';  // И выводим информационное сообщение
                    return; // Производим выход из данной функции
                }
                // Запрашиваем список должностей соответствующих текущей категории
                const response = await fetch(`api/positions/${selectedCategoryId}/`); // 
                const data = await response.json();  // Получаем json-объект со списком должностей

                positionSelect.disabled = false;   // Делаем элемент PositionSelect доступным для взаимодействия
                positionSelect.innerHTML = '';    // Очищаем элемент PositionSelect

                data.forEach((position) => {    // Перебираем список полученных должностей и в каждой итерации  
                    const option = document.createElement('option');  // Создаём  элемент option 
                    option.value = position.id;                       // Присваиваем текущий идентификатор
                    option.textContent = position.name_position;      // Присваиваем текущее наименование
                    positionSelect.appendChild(option);                // Добавляем получившийся объект option в элемент positions
                }) 
              });
              }
            )
</script>
      </div>

      <div class="mx-auto p-2 mb-3" style="width: 100px;">  
        <button type="submit" class="btn btn-outline-primary">Сохранить</button>
      </div>
  </form>  

    <center><button onclick="window.location.href='/employlist/'" class="btn btn-outline-primary">Вернуться к списку сотрудников</button></center>
</div> 

<script src="{% static 'js/AddEmploy.js' %}"></script>
  
{% endblock %}
